define(["core/utils"],function(e){return function(e,t,s,i){function o(e){var t=e.length;if(2>t||t>256||t&t-1)throw"Invalid code/color length, must be power of 2 and 2 .. 256.";return t}function l(e,t,s,i){function c(s){for(;g>=s;)e[t++]=255&l,l>>=8,g-=8,t===n+256&&(e[n]=255,n=t++)}function u(e){l|=e<<g,g+=A,c(8)}e[t++]=s;var n=t++,a=1<<s,r=a-1,o=a+1,h=o+1,A=s+1,g=0,l=0,p=i[0]&r,f={};u(a);for(var d=1,_=i.length;_>d;++d){var m=i[d]&r,Q=p<<8|m,v=f[Q];if(void 0===v){for(l|=p<<g,g+=A;g>=8;)e[t++]=255&l,l>>=8,g-=8,t===n+256&&(e[n]=255,n=t++);4096===h?(u(a),h=o+1,A=s+1,f={}):(h>=1<<A&&++A,f[Q]=h++),p=m}else p=v}return u(p),u(o),c(1),n+1===t?e[n]=0:(e[n]=t-n-1,e[t++]=0),t}var n=0;i=void 0===i?{}:i;var a=void 0===i.loop?null:i.loop,r=void 0===i.palette?null:i.palette;if(0>=t||0>=s||t>65535||s>65535)throw"Width/Height invalid.";e[n++]=71,e[n++]=73,e[n++]=70,e[n++]=56,e[n++]=57,e[n++]=97;var h=0,A=0;if(e[n++]=255&t,e[n++]=t>>8&255,e[n++]=255&s,e[n++]=s>>8&255,e[n++]=(null!==r?128:0)|h,e[n++]=A,e[n++]=0,null!==a){if(0>a||a>65535)throw"Loop count invalid.";e[n++]=33,e[n++]=255,e[n++]=11,e[n++]=78,e[n++]=69,e[n++]=84,e[n++]=83,e[n++]=67,e[n++]=65,e[n++]=80,e[n++]=69,e[n++]=50,e[n++]=46,e[n++]=48,e[n++]=3,e[n++]=1,e[n++]=255&a,e[n++]=a>>8&255,e[n++]=0}var g=!1;this.addFrame=function(t,s,i,a,h,A){if(g===!0&&(--n,g=!1),A=void 0===A?{}:A,0>t||0>s||t>65535||s>65535)throw"x/y invalid.";if(0>=i||0>=a||i>65535||a>65535)throw"Width/Height invalid.";if(h.length<i*a)throw"Not enough pixels for the frame size.";var c=!0,u=A.palette;if((void 0===u||null===u)&&(c=!1,u=r),void 0===u||null===u)throw"Must supply either a local or global palette.";for(var p=o(u),f=0;p>>=1;)++f;p=1<<f;var d=void 0===A.delay?0:A.delay,_=void 0===A.disposal?0:A.disposal;if(0>_||_>3)throw"Disposal out of range.";var m=!1,Q=0;if(void 0!==A.transparent&&null!==A.transparent&&(m=!0,Q=A.transparent,0>Q||Q>=p))throw"Transparent color index.";if((0!==_||m||0!==d)&&(e[n++]=33,e[n++]=249,e[n++]=4,e[n++]=_<<2|(m===!0?1:0),e[n++]=255&d,e[n++]=d>>8&255,e[n++]=Q,e[n++]=0),e[n++]=44,e[n++]=255&t,e[n++]=t>>8&255,e[n++]=255&s,e[n++]=s>>8&255,e[n++]=255&i,e[n++]=i>>8&255,e[n++]=255&a,e[n++]=a>>8&255,e[n++]=c===!0?128|f-1:0,c===!0)for(var v=0,y=u.length;y>v;++v){var w=u[v];e[n++]=w>>16&255,e[n++]=w>>8&255,e[n++]=255&w}n=l(e,n,2>f?2:f,h)},this.end=function(){return g===!1&&(e[n++]=59,g=!0),n}}});