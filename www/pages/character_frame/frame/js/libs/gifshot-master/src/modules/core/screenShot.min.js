define(["core/utils","core/AnimatedGIF"],function(e,t){return{getGIF:function(s,i){i=e.isFunction(i)?i:e.noop;var a,n=document.createElement("canvas"),r=s.images,o=!!r.length,h=s.videoElement,A=s.keepCameraOn,g=s.webcamVideoElement,l=s.cameraStream,c=+s.gifWidth,u=+s.gifHeight,p=s.videoWidth,f=s.videoHeight,m=(+s.sampleInterval,+s.numWorkers,s.crop),Q=+s.interval,v=o?0:1e3*Q,y=s.progressCallback,w=s.savedRenderingContexts,B=s.saveRenderingContexts,b=[],I=w.length?w.length:s.numFrames,E=I,T=new t(s),C=s.text,x=s.fontWeight,S=e.getFontSize(s),F=s.fontFamily,D=s.fontColor,k=s.textAlign,L=s.textBaseline,j=s.textXCoordinate?s.textXCoordinate:"left"===k?1:"right"===k?c:c/2,P=s.textYCoordinate?s.textYCoordinate:"top"===L?1:"center"===L?u/2:u,R=x+" "+S+" "+F,O=m?Math.floor(m.scaledWidth/2):0,H=m?p-m.scaledWidth:0,N=m?Math.floor(m.scaledHeight/2):0,M=m?f-m.scaledHeight:0,G=function X(){function s(){try{H>p&&(H=p),M>f&&(M=f),0>O&&(O=0),0>N&&(N=0),a.drawImage(h,O,N,H,M,0,0,c,u),n()}catch(t){if("NS_ERROR_NOT_AVAILABLE"!==t.name)throw t;e.requestTimeout(s,100)}}function n(){E=t;var r,o,p,f,n=I-E;B&&b.push(a.getImageData(0,0,c,u)),C&&(a.font=R,a.fillStyle=D,a.textAlign=k,a.textBaseline=L,a.fillText(C,j,P)),r=a.getImageData(0,0,c,u),o=r.data,p=o[0]+o[1]+o[2]+o[3],f=0===p,f?1===n&&1===I&&s():T.addFrameImageData(r),y(n/I),t>0&&e.requestTimeout(X,v),E||T.getBase64GIF(function(e){i({error:!1,errorCode:"",errorMsg:"",image:e,cameraStream:l,videoElement:h,webcamVideoElement:g,savedRenderingContexts:b,keepCameraOn:A})})}var t=E-1;w.length?(a.putImageData(w[I-E],0,0),n()):s()};I=null!=I?I:10,Q=null!=Q?Q:.1,n.width=c,n.height=u,a=n.getContext("2d"),function Y(){return w.length||0!==h.currentTime?void G():void e.requestTimeout(Y,100)}()},getCropDimensions:function(e){var t=e.videoWidth,s=e.videoHeight,i=e.gifWidth,n=e.gifHeight,a={width:0,height:0,scaledWidth:0,scaledHeight:0};return t>s?(a.width=Math.round(t*(n/s))-i,a.scaledWidth=Math.round(a.width*(s/n))):(a.height=Math.round(s*(i/t))-n,a.scaledHeight=Math.round(a.height*(t/i))),a}}});