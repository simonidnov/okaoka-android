define(["core/utils","core/processFrameWorker","dependencies/NeuQuant","dependencies/gifWriter"],function(e,t,s,i){var n=function(t){this.canvas=null,this.ctx=null,this.repeat=0,this.frames=[],this.numRenderedFrames=0,this.onRenderCompleteCallback=e.noop,this.onRenderProgressCallback=e.noop,this.workers=[],this.availableWorkers=[],this.generatingGIF=!1,this.options=t,this.initializeWebWorkers(t)};return n.prototype={workerMethods:t(),initializeWebWorkers:function(i){var a,r,o,h,n=s.toString()+"("+t.toString()+"());",A=-1,g="";for(h=i.numWorkers;++A<h;)a=e.createWebWorker(n),e.isObject(a)?(r=a.objectUrl,o=a.worker,this.workers.push({worker:o,objectUrl:r}),this.availableWorkers.push(o)):(g=a,e.webWorkerError=!!a);this.workerError=g,this.canvas=document.createElement("canvas"),this.canvas.width=i.gifWidth,this.canvas.height=i.gifHeight,this.ctx=this.canvas.getContext("2d"),this.frames=[]},getWorker:function(){return this.availableWorkers.pop()},freeWorker:function(e){this.availableWorkers.push(e)},byteMap:function(){for(var e=[],t=0;256>t;t++)e[t]=String.fromCharCode(t);return e}(),bufferToString:function(e){for(var t=e.length,s="",i=-1;++i<t;)s+=this.byteMap[e[i]];return s},onFrameFinished:function(t){var s=this,i=s.frames,n=s.options;hasExistingImages=!!(n.images||[]).length,allDone=i.every(function(e){return!e.beingProcessed&&e.done}),s.numRenderedFrames++,hasExistingImages&&t(s.numRenderedFrames/i.length),s.onRenderProgressCallback(.75*s.numRenderedFrames/i.length),allDone?s.generatingGIF||s.generateGIF(i,s.onRenderCompleteCallback):e.requestTimeout(function(){s.processNextFrame()},1)},processFrame:function(e){var r,o,t=this,s=this.options,i=s.progressCallback,n=s.sampleInterval,a=this.frames,h=function(e){var s=e.data;delete r.data,r.pixels=Array.prototype.slice.call(s.pixels),r.palette=Array.prototype.slice.call(s.palette),r.done=!0,r.beingProcessed=!1,t.freeWorker(o),t.onFrameFinished(i)};return r=a[e],r.beingProcessed||r.done?void this.onFrameFinished():(r.sampleInterval=n,r.beingProcessed=!0,r.gifshot=!0,o=this.getWorker(),void(o?(o.onmessage=h,o.postMessage(r)):h({data:t.workerMethods.run(r)})))},startRendering:function(e){this.onRenderCompleteCallback=e;for(var t=0;t<this.options.numWorkers&&t<this.frames.length;t++)this.processFrame(t)},processNextFrame:function(){for(var e=-1,t=0;t<this.frames.length;t++){var s=this.frames[t];if(!s.done&&!s.beingProcessed){e=t;break}}e>=0&&this.processFrame(e)},generateGIF:function(t,s){var f,d,n=[],a={loop:this.repeat},r=this.options,o=r.interval,h=r.images,A=!!h.length,g=r.gifHeight,l=r.gifWidth,c=new i(n,l,g,a),u=this.onRenderProgressCallback,p=A?100*o:0;this.generatingGIF=!0,e.each(t,function(e,s){var i=s.palette;u(.75+.25*s.position*1/t.length),c.addFrame(0,0,l,g,s.pixels,{palette:i,delay:p})}),c.end(),u(1),this.frames=[],this.generatingGIF=!1,e.isFunction(s)&&(f=this.bufferToString(n),d="data:image/gif;base64,"+e.btoa(f),s(d))},setRepeat:function(e){this.repeat=e},addFrame:function(t,s){s=e.isObject(s)?s:{};var v,i=this,n=i.ctx,a=i.options,r=a.gifWidth,o=a.gifHeight,g=(s.gifHeight,s.gifWidth,s.text),l=s.fontWeight,c=e.getFontSize(s),u=s.fontFamily,p=s.fontColor,f=s.textAlign,d=s.textBaseline,_=s.textXCoordinate?s.textXCoordinate:"left"===f?1:"right"===f?r:r/2,m=s.textYCoordinate?s.textYCoordinate:"top"===d?1:"center"===d?o/2:o,Q=l+" "+c+" "+u;try{n.drawImage(t,0,0,r,o),g&&(n.font=Q,n.fillStyle=p,n.textAlign=f,n.textBaseline=d,n.fillText(g,_,m)),v=n.getImageData(0,0,r,o),i.addFrameImageData(v)}catch(y){return""+y}},addFrameImageData:function(e){var t=this.frames,s=e.data;this.frames.push({data:s,width:e.width,height:e.height,palette:null,dithering:null,done:!1,beingProcessed:!1,position:t.length})},onRenderProgress:function(e){this.onRenderProgressCallback=e},isRendering:function(){return this.generatingGIF},getBase64GIF:function(t){var s=this,i=function(i){s.destroyWorkers(),e.requestTimeout(function(){t(i)},0)};s.startRendering(i)},destroyWorkers:function(){if(!this.workerError){var t=this.workers;e.each(t,function(t,s){var i=s.worker,n=s.objectUrl;i.terminate(),e.URL.revokeObjectURL(n)})}}},n});