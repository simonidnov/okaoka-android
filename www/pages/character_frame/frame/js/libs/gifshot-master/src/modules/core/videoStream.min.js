define(["core/utils"],function(e){return{loadedData:!1,defaultVideoDimensions:{width:640,height:480},findVideoSize:function t(s){t.attempts=t.attempts||0;var i=this,n=s.videoElement,a=s.cameraStream,r=s.completedCallback;n&&(n.videoWidth>0&&n.videoHeight>0?(n.removeEventListener("loadeddata",i.findVideoSize),r({videoElement:n,cameraStream:a,videoWidth:n.videoWidth,videoHeight:n.videoHeight})):t.attempts<10?(t.attempts+=1,e.requestTimeout(function(){i.findVideoSize(s)},200)):r({videoElement:n,cameraStream:a,videoWidth:i.defaultVideoDimensions.width,videoHeight:i.defaultVideoDimensions.height}))},onStreamingTimeout:function(t){e.isFunction(t)&&t({error:!0,errorCode:"getUserMedia",errorMsg:"There was an issue with the getUserMedia API - Timed out while trying to start streaming",image:null,cameraStream:{}})},stream:function(t){var s=this,i=e.isArray(t.existingVideo)?t.existingVideo[0]:t.existingVideo,n=t.videoElement,a=t.cameraStream,r=t.streamedCallback,o=t.completedCallback;e.isFunction(r)&&r(),i?e.isString(i)&&(n.src=i,n.innerHTML='<source src="'+i+'" type="video/'+e.getExtension(i)+'" />'):n.mozSrcObject?n.mozSrcObject=a:e.URL&&(n.src=e.URL.createObjectURL(a)),n.play(),e.requestTimeout(function h(){h.count=h.count||0,s.loadedData===!0?(s.findVideoSize({videoElement:n,cameraStream:a,completedCallback:o}),s.loadedData=!1):(h.count+=1,h.count>10?s.findVideoSize({videoElement:n,cameraStream:a,completedCallback:o}):h())},100)},startStreaming:function(t){var s=this,i=e.isFunction(t.error)?t.error:e.noop,n=e.isFunction(t.streamed)?t.streamed:e.noop,a=e.isFunction(t.completed)?t.completed:e.noop,r=t.existingVideo,o=t.webcamVideoElement,h=e.isElement(r)?r:o?o:document.createElement("video"),A=t.lastCameraStream,g=t.crossOrigin,l=t.options;g&&(h.crossOrigin=l.crossOrigin),h.autoplay=!0,h.loop=!0,h.muted=!0,h.addEventListener("loadeddata",function(e){s.loadedData=!0}),r?s.stream({videoElement:h,existingVideo:r,completedCallback:a}):A?s.stream({videoElement:h,cameraStream:A,streamedCallback:n,completedCallback:a}):e.getUserMedia({video:!0},function(e){s.stream({videoElement:h,cameraStream:e,streamedCallback:n,completedCallback:a})},i)},startVideoStreaming:function(t,s){s=s||{};var n,i=this,a=void 0!==s.timeout?s.timeout:0,r=s.callback,o=s.webcamVideoElement;a>0&&(n=e.requestTimeout(function(){i.onStreamingTimeout(r)},1e4)),this.startStreaming({error:function(){r({error:!0,errorCode:"getUserMedia",errorMsg:"There was an issue with the getUserMedia API - the user probably denied permission",image:null,cameraStream:{}})},streamed:function(){clearTimeout(n)},completed:function(e){var s=e.cameraStream,i=e.videoElement,n=e.videoWidth,a=e.videoHeight;t({cameraStream:s,videoElement:i,videoWidth:n,videoHeight:a})},lastCameraStream:s.lastCameraStream,webcamVideoElement:o,crossOrigin:s.crossOrigin,options:s})},stopVideoStreaming:function(t){t=e.isObject(t)?t:{};var s=t.cameraStream,i=t.videoElement,n=t.keepCameraOn,a=t.webcamVideoElement;!n&&s&&e.isFunction(s.stop)&&s.stop(),e.isElement(i)&&!a&&(i.pause(),e.isFunction(e.URL.revokeObjectURL)&&!e.webWorkerError&&i.src&&e.URL.revokeObjectURL(i.src),e.removeElement(i))}}});