var gulp=require("gulp"),uglify=require("gulp-uglify"),insert=require("gulp-insert"),rename=require("gulp-rename"),mocha=require("gulp-mocha"),istanbul=require("gulp-istanbul"),rimraf=require("gulp-rimraf"),_=require("lodash"),rjs=require("requirejs"),amdclean=require("amdclean"),fs=require("fs"),packageJson=JSON.parse(fs.readFileSync("./package.json","utf8")),licenseText="/*"+fs.readFileSync("./LICENSE.txt","utf8")+"\n*/\n",configs={rjs:{findNestedDependencies:!0,baseUrl:"src/modules/",preserveLicenseComments:!1,optimize:"none",skipModuleInsertion:!0,include:["index"]},amdclean:{transformAMDChecks:!1,aggressiveOptimizations:!1,createAnonymousAMDModule:!0,prefixTransform:function(e){return e.substring(e.indexOf("_")+1,e.length)},wrap:{start:";(function(window, document, navigator, undefined) {\n",end:'\n}(typeof window !== "undefined" ? window : {}, typeof document !== "undefined" ? document : { createElement: function() {} }, typeof window !== "undefined" ? window.navigator : {}));'},escodegen:{comment:!1}},jshint:{loopfunc:!0}},customBuild={webcam:{modulesToRemove:["isExistingImagesGIFSupported","isExistingVideoGIFSupported","existingImages","existingVideo"]},image:{modulesToRemove:["isWebCamGIFSupported","isExistingVideoGIFSupported","stopVideoStreaming","existingVideo","existingWebcam","videoStream"]},video:{modulesToRemove:["isExistingImagesGIFSupported","isWebCamGIFSupported","stopVideoStreaming","existingImages","existingWebcam"]}},getCommandLineArguments=function(){var e=[];return process.argv.forEach(function(t,s){"-"===t.charAt(0)&&"-"===t.charAt(1)&&e.push(t.substring(2,t.length))}),e};gulp.task("concat",function(e){var t="src/gifshot.js",s=_.merge(_.clone(configs.rjs),{out:t});rjs.optimize(s,function(){var s=_.merge(_.clone(configs.amdclean),{filePath:t});fs.writeFileSync(t,amdclean.clean(s)),e()},function(t){return e(t)})}),gulp.task("test",["concat"],function(e){var t="tests/gifshot.test.js",s=_.merge(_.clone(configs.rjs),{out:t});rjs.optimize(s,function(){var s=_.merge(_.clone(configs.amdclean),{filePath:t,removeModules:["gifWriter","NeuQuant","AnimatedGIF","createAndGetGIF","existingImages","existingVideo","getBase64GIF","processFrameWorker","screenShot","videoStream"]});fs.writeFileSync(t,amdclean.clean(s)),gulp.src(t).pipe(istanbul()).on("finish",function(){gulp.src("tests/gifshot-tests.js").pipe(mocha({reporter:"nyan"})).pipe(istanbul.writeReports()).on("end",e)})},function(t){return e(t)})}),gulp.task("copy",["concat","test"],function(){gulp.src(["src/gifshot.js"]).pipe(insert.prepend(licenseText)).pipe(gulp.dest("build")).pipe(gulp.dest("demo/js/dependencies"))}),gulp.task("minify",["concat","test","copy"],function(){gulp.src(["src/gifshot.js"]).pipe(uglify()).pipe(rename("gifshot.min.js")).pipe(insert.prepend(licenseText)).pipe(gulp.dest("build")).pipe(gulp.dest("demo/js/dependencies"))}),gulp.task("cleanup",["concat","test","copy","minify"],function(){gulp.src(["src/gifshot.js","tests/gifshot.test.js"],{read:!1}).pipe(rimraf())}),gulp.task("custom-build",function(){var i,e=getCommandLineArguments(),t=[],s="build/custom/gifshot.custom.js";e.length||e.push("webcam"),e.forEach(function(e){customBuild[e]&&customBuild[e].modulesToRemove?customBuild[e].modulesToRemove.forEach(function(e){t.push(e)}):t.push(e)}),i=_.merge(_.clone(configs.rjs),{out:s}),rjs.optimize(i,function(){var e=_.merge(_.clone(configs.amdclean),{filePath:s,removeModules:t});fs.writeFileSync(s,amdclean.clean(e)),gulp.src(s).pipe(insert.prepend(licenseText)).pipe(gulp.dest("demo")).pipe(uglify()).pipe(rename("gifshot.custom.min.js")).pipe(insert.prepend(licenseText)).pipe(gulp.dest("build/custom")),cb()},function(e){return cb(e)})}),gulp.task("default",["concat","test","copy","minify","cleanup"]),gulp.task("watch",function(){var e=gulp.watch("src/modules/**/*.js",["default"]);e.on("change",function(e){console.log("File "+e.path+" was "+e.type+", running tasks...")})});