this.createjs=this.createjs||{},function(){"use strict";function e(e){this.Container_constructor(),this.spriteSheet=e}var t=createjs.extend(e,createjs.Container);t.addChild=function(e){return null==e?e:arguments.length>1?this.addChildAt.apply(this,Array.prototype.slice.call(arguments).concat([this.children.length])):this.addChildAt(e,this.children.length)},t.addChildAt=function(e,t){var s=arguments.length,i=arguments[s-1];if(0>i||i>this.children.length)return arguments[s-2];if(s>2){for(var n=0;s-1>n;n++)this.addChildAt(arguments[n],i+n);return arguments[s-2]}if(!(e._spritestage_compatibility>=1))return console&&console.log("Error: You can only add children of type SpriteContainer, Sprite, BitmapText, or DOMElement ["+e.toString()+"]"),e;if(e._spritestage_compatibility<=4){var a=e.spriteSheet;if(!a||!a._images||a._images.length>1||this.spriteSheet&&this.spriteSheet!==a)return console&&console.log("Error: A child's spriteSheet must be equal to its parent spriteSheet and only use one image. ["+e.toString()+"]"),e;this.spriteSheet=a}return e.parent&&e.parent.removeChild(e),e.parent=this,this.children.splice(t,0,e),e},t.toString=function(){return"[SpriteContainer (name="+this.name+")]"},createjs.SpriteContainer=createjs.promote(e,"Container")}(),this.createjs=this.createjs||{},function(){"use strict";function e(e,t,s){this.Stage_constructor(e),this._preserveDrawingBuffer=t||!1,this._antialias=s||!1,this._viewportWidth=0,this._viewportHeight=0,this._projectionMatrix=null,this._webGLContext=null,this._webGLErrorDetected=!1,this._clearColor=null,this._maxTexturesPerDraw=1,this._maxBoxesPointsPerDraw=null,this._maxBoxesPerDraw=null,this._maxIndicesPerDraw=null,this._shaderProgram=null,this._vertices=null,this._verticesBuffer=null,this._indices=null,this._indicesBuffer=null,this._currentBoxIndex=-1,this._drawTexture=null,this._initializeWebGL()}[createjs.SpriteContainer,createjs.Sprite,createjs.BitmapText,createjs.Bitmap,createjs.DOMElement].forEach(function(e,t){e.prototype._spritestage_compatibility=t+1});var t=createjs.extend(e,createjs.Stage);e.NUM_VERTEX_PROPERTIES=5,e.POINTS_PER_BOX=4,e.NUM_VERTEX_PROPERTIES_PER_BOX=e.POINTS_PER_BOX*e.NUM_VERTEX_PROPERTIES,e.INDICES_PER_BOX=6,e.MAX_INDEX_SIZE=Math.pow(2,16),e.MAX_BOXES_POINTS_INCREMENT=e.MAX_INDEX_SIZE/4,t._get_isWebGL=function(){return!!this._webGLContext};try{Object.defineProperties(t,{isWebGL:{get:t._get_isWebGL}})}catch(s){}t.addChild=function(e){return null==e?e:arguments.length>1?this.addChildAt.apply(this,Array.prototype.slice.call(arguments).concat([this.children.length])):this.addChildAt(e,this.children.length)},t.addChildAt=function(e,t){var s=arguments.length,i=arguments[s-1];if(0>i||i>this.children.length)return arguments[s-2];if(s>2){for(var n=0;s-1>n;n++)this.addChildAt(arguments[n],i+n);return arguments[s-2]}return e._spritestage_compatibility>=1?!e.image&&!e.spriteSheet&&e._spritestage_compatibility<=4?(console&&console.log("Error: You can only add children that have an image or spriteSheet defined on them. ["+e.toString()+"]"),e):(e.parent&&e.parent.removeChild(e),e.parent=this,this.children.splice(t,0,e),e):(console&&console.log("Error: You can only add children of type SpriteContainer, Sprite, Bitmap, BitmapText, or DOMElement. ["+e.toString()+"]"),e)},t.update=function(e){if(this.canvas){this.tickOnUpdate&&this.tick(e),this.dispatchEvent("drawstart"),this.autoClear&&this.clear();var t=this._setWebGLContext();t?this.draw(t,!1):(t=this.canvas.getContext("2d"),t.save(),this.updateContext(t),this.draw(t,!1),t.restore()),this.dispatchEvent("drawend")}},t.clear=function(){if(this.canvas){var e=this._setWebGLContext();e?e.clear(e.COLOR_BUFFER_BIT):(e=this.canvas.getContext("2d"),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,this.canvas.width+1,this.canvas.height+1))}},t.draw=function(e,t){return"undefined"!=typeof WebGLRenderingContext&&(e===this._webGLContext||e instanceof WebGLRenderingContext)?(this._drawWebGLKids(this.children,e),!0):this.Stage_draw(e,t)},t.updateViewport=function(e,t){this._viewportWidth=e,this._viewportHeight=t,this._webGLContext&&(this._webGLContext.viewport(0,0,this._viewportWidth,this._viewportHeight),this._projectionMatrix||(this._projectionMatrix=new Float32Array([0,0,0,0,0,1,-1,1,1])),this._projectionMatrix[0]=2/e,this._projectionMatrix[4]=-2/t)},t.clearImageTexture=function(e){e.__easeljs_texture=null},t.toString=function(){return"[SpriteStage (name="+this.name+")]"},t._initializeWebGL=function(){this._clearColor={r:0,g:0,b:0,a:0},this._setWebGLContext()},t._setWebGLContext=function(){return this.canvas?this._webGLContext&&this._webGLContext.canvas===this.canvas||this._initializeWebGLContext():this._webGLContext=null,this._webGLContext},t._initializeWebGLContext=function(){var e={depth:!1,alpha:!0,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias,premultipliedAlpha:!0},t=this._webGLContext=this.canvas.getContext("webgl",e)||this.canvas.getContext("experimental-webgl",e);if(t){if(this._maxTexturesPerDraw=1,this._setClearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a),t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),this._createShaderProgram(t),this._webGLErrorDetected)return void(this._webGLContext=null);this._createBuffers(t),this.updateViewport(this._viewportWidth||this.canvas.width||0,this._viewportHeight||this.canvas.height||0)}},t._setClearColor=function(e,t,s,i){this._clearColor.r=e,this._clearColor.g=t,this._clearColor.b=s,this._clearColor.a=i,this._webGLContext&&this._webGLContext.clearColor(e,t,s,i)},t._createShaderProgram=function(e){var t=this._createShader(e,e.FRAGMENT_SHADER,"precision mediump float;uniform sampler2D uSampler0;varying vec3 vTextureCoord;void main(void) {vec4 color = texture2D(uSampler0, vTextureCoord.st);gl_FragColor = vec4(color.rgb, color.a * vTextureCoord.z);}"),s=this._createShader(e,e.VERTEX_SHADER,"attribute vec2 aVertexPosition;attribute vec3 aTextureCoord;uniform mat3 uPMatrix;varying vec3 vTextureCoord;void main(void) {vTextureCoord = aTextureCoord;gl_Position = vec4((uPMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);}");if(!this._webGLErrorDetected&&t&&s){var i=e.createProgram();if(e.attachShader(i,t),e.attachShader(i,s),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS))return void(this._webGLErrorDetected=!0);i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition"),i.textureCoordAttribute=e.getAttribLocation(i,"aTextureCoord"),i.sampler0uniform=e.getUniformLocation(i,"uSampler0"),e.enableVertexAttribArray(i.vertexPositionAttribute),e.enableVertexAttribArray(i.textureCoordAttribute),i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix"),e.useProgram(i),this._shaderProgram=i}},t._createShader=function(e,t,s){var i=e.createShader(t);return e.shaderSource(i,s),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)?i:(this._webGLErrorDetected=!0,null)},t._createBuffers=function(t){this._verticesBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._verticesBuffer);var s=4*e.NUM_VERTEX_PROPERTIES;t.vertexAttribPointer(this._shaderProgram.vertexPositionAttribute,2,t.FLOAT,t.FALSE,s,0),t.vertexAttribPointer(this._shaderProgram.textureCoordAttribute,3,t.FLOAT,t.FALSE,s,8),this._indicesBuffer=t.createBuffer(),this._setMaxBoxesPoints(t,e.MAX_BOXES_POINTS_INCREMENT)},t._setMaxBoxesPoints=function(t,s){this._maxBoxesPointsPerDraw=s,this._maxBoxesPerDraw=this._maxBoxesPointsPerDraw/e.POINTS_PER_BOX|0,this._maxIndicesPerDraw=this._maxBoxesPerDraw*e.INDICES_PER_BOX,t.bindBuffer(t.ARRAY_BUFFER,this._verticesBuffer),this._vertices=new Float32Array(this._maxBoxesPerDraw*e.NUM_VERTEX_PROPERTIES_PER_BOX),t.bufferData(t.ARRAY_BUFFER,this._vertices,t.DYNAMIC_DRAW),this._indices=new Uint16Array(this._maxIndicesPerDraw);for(var i=0,n=this._indices.length;n>i;i+=e.INDICES_PER_BOX){var a=i*e.POINTS_PER_BOX/e.INDICES_PER_BOX;this._indices[i]=a,this._indices[i+1]=a+1,this._indices[i+2]=a+2,this._indices[i+3]=a,this._indices[i+4]=a+2,this._indices[i+5]=a+3}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this._indices,t.STATIC_DRAW)},t._setupImageTexture=function(e,t){if(t&&(t.naturalWidth||t.getContext||t.readyState>=2)){var s=t.__easeljs_texture;return s||(s=t.__easeljs_texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),s}},t._drawWebGLKids=function(t,s,i){for(var n,a,r=this.snapToPixelEnabled,o=null,h=0,A=0,g=0,l=0,c=this._vertices,u=e.NUM_VERTEX_PROPERTIES_PER_BOX,p=e.MAX_INDEX_SIZE,f=this._maxBoxesPerDraw-1,d=0,_=t.length;_>d;d++)if(n=t[d],n.isVisible()){var o=n.image||n.spriteSheet&&n.spriteSheet._images[0],m=o.__easeljs_texture;if(m||(m=this._setupImageTexture(s,o))){a=n._props.matrix,a=(i?a.copy(i):a.identity()).appendTransform(n.x,n.y,n.scaleX,n.scaleY,n.rotation,n.skewX,n.skewY,n.regX,n.regY);var Q=0,v=1,y=0,w=1;if(4===n._spritestage_compatibility)h=0,A=0,g=o.width,l=o.height;else if(2===n._spritestage_compatibility){var B=n.spriteSheet.getFrame(n.currentFrame),b=B.rect;h=-B.regX,A=-B.regY,g=h+b.width,l=A+b.height,Q=b.x/o.width,y=b.y/o.height,v=Q+b.width/o.width,w=y+b.height/o.height}else o=null,3===n._spritestage_compatibility&&n._updateText();if(!i&&n._spritestage_compatibility<=4&&m!==this._drawTexture&&(this._drawToGPU(s),this._drawTexture=m),null!==o){var I=++this._currentBoxIndex*u,E=a.a,T=a.b,C=a.c,x=a.d,S=a.tx,F=a.ty;r&&n.snapToPixel&&(S=S+(0>S?-.5:.5)|0,F=F+(0>F?-.5:.5)|0),c[I]=h*E+A*C+S,c[I+1]=h*T+A*x+F,c[I+5]=h*E+l*C+S,c[I+6]=h*T+l*x+F,c[I+10]=g*E+l*C+S,c[I+11]=g*T+l*x+F,c[I+15]=g*E+A*C+S,c[I+16]=g*T+A*x+F,c[I+2]=c[I+7]=Q,c[I+12]=c[I+17]=v,c[I+3]=c[I+18]=y,c[I+8]=c[I+13]=w,c[I+4]=c[I+9]=c[I+14]=c[I+19]=n.alpha,this._currentBoxIndex===f&&(this._drawToGPU(s),this._drawTexture=m,this._maxBoxesPointsPerDraw<p&&(this._setMaxBoxesPoints(s,this._maxBoxesPointsPerDraw+e.MAX_BOXES_POINTS_INCREMENT),f=this._maxBoxesPerDraw-1))}n.children&&(this._drawWebGLKids(n.children,s,a),f=this._maxBoxesPerDraw-1)}}i||this._drawToGPU(s)},t._drawToGPU=function(t){if(this._drawTexture){var s=this._currentBoxIndex+1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._drawTexture),t.uniform1i(this._shaderProgram.sampler0uniform,0),t.bindBuffer(t.ARRAY_BUFFER,this._verticesBuffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),t.uniformMatrix3fv(this._shaderProgram.pMatrixUniform,!1,this._projectionMatrix),t.bufferSubData(t.ARRAY_BUFFER,0,this._vertices),t.drawElements(t.TRIANGLES,s*e.INDICES_PER_BOX,t.UNSIGNED_SHORT,0),this._currentBoxIndex=-1,this._drawTexture=null}},createjs.SpriteStage=createjs.promote(e,"Stage")}();