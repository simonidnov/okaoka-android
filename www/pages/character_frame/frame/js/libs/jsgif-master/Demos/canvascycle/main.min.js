var encoder=new GIFEncoder;encoder.setRepeat(0),encoder.setDelay(25),encoder.start(),FrameCount.visible=!1;var CanvasCycle={cookie:new CookieTree,ctx:null,imageData:null,clock:0,inGame:!1,bmp:null,globalTimeStart:(new Date).getTime(),inited:!1,optTween:null,winSize:null,globalBrightness:1,lastBrightness:0,sceneIdx:-1,highlightColor:-1,defaultMaxVolume:.5,settings:{showOptions:!1,targetFPS:60,zoomFull:!1,blendShiftEnabled:!0,speedAdjust:1,sound:!0},contentSize:{width:640,optionsWidth:0,height:520,scale:1},init:function(){if(!this.inited){this.inited=!0,$("container").style.display="block",$("d_options").style.display="none",FrameCount.init(),this.handleResize();for(var e=$("palette_display"),t=0,s=256;s>t;t++){var i=document.createElement("div");i._idx=t,i.id="pal_"+t,i.className="palette_color",i.onmouseover=function(){CanvasCycle.highlightColor=this._idx},i.onmouseout=function(){CanvasCycle.highlightColor=-1},e.appendChild(i)}var i=document.createElement("div");i.className="clear",e.appendChild(i);var n=0,a="";a+='<select id="fe_scene" onChange="CanvasCycle.switchScene(this)">';for(var t=0,s=scenes.length;s>t;t++){var r=scenes[t];a+='<option value="'+r.name+'" '+(t==n?' selected="selected"':"")+">"+r.title+"</option>"}a+="</select>",$("d_scene_selector").innerHTML=a;var o=this.cookie.get("settings");o&&(o.showOptions&&this.toggleOptions(),this.setRate(o.targetFPS),this.setZoom(o.zoomFull),this.setSpeed(o.speedAdjust),this.setBlendShift(o.blendShiftEnabled),this.setSound(o.sound)),location.href.match(/\bsound\=(\d+)/)&&this.setSound(!!parseInt(RegExp.$1,10)),this.loadImage(scenes[n].name),this.sceneIdx=n}},jumpScene:function(e){this.sceneIdx+=e,this.sceneIdx>=scenes.length?this.sceneIdx=0:this.sceneIdx<0&&(this.sceneIdx=scenes.length-1),$("fe_scene").selectedIndex=this.sceneIdx,this.switchScene($("fe_scene"))},switchScene:function(e){this.stopSceneAudio();var t=e.options[e.selectedIndex].value;this.sceneIdx=e.selectedIndex,ua.mobile?(this.inGame=!1,this.ctx.clearRect(0,0,this.bmp.width,this.bmp.height),this.ctx.fillStyle="rgb(0,0,0)",this.ctx.fillRect(0,0,this.bmp.width,this.bmp.height),CanvasCycle.globalBrightness=1,CanvasCycle.loadImage(t)):(TweenManager.removeAll({category:"scenefade"}),TweenManager.tween({target:{value:this.globalBrightness,newSceneName:t},duration:Math.floor(this.settings.targetFPS/2),mode:"EaseInOut",algo:"Quadratic",props:{value:0},onTweenUpdate:function(e){CanvasCycle.globalBrightness=e.target.value},onTweenComplete:function(e){CanvasCycle.loadImage(e.target.newSceneName)},category:"scenefade"}))},loadImage:function(e){var t=$("d_loading");t.style.left=""+Math.floor(this.contentSize.width*this.contentSize.scale/2-16)+"px",t.style.top=""+Math.floor(this.contentSize.height*this.contentSize.scale/2-16)+"px",t.show();var s="image.php?file="+e+"&callback=CanvasCycle.processImage",i=document.createElement("SCRIPT");i.type="text/javascript",i.src=s,document.getElementsByTagName("HEAD")[0].appendChild(i)},processImage:function(e){$("d_loading").hide(),this.bmp=new Bitmap(e),this.bmp.optimize();var t=$("mycanvas");if(t.getContext){if(this.ctx||(this.ctx=t.getContext("2d")),this.ctx.clearRect(0,0,this.bmp.width,this.bmp.height),this.ctx.fillStyle="rgb(0,0,0)",this.ctx.fillRect(0,0,this.bmp.width,this.bmp.height),!this.imageData)if(this.ctx.createImageData)this.imageData=this.ctx.createImageData(this.bmp.width,this.bmp.height);else{if(!this.ctx.getImageData)return;this.imageData=this.ctx.getImageData(0,0,this.bmp.width,this.bmp.height)}ua.mobile?this.globalBrightness=1:(this.globalBrightness=0,TweenManager.removeAll({category:"scenefade"}),TweenManager.tween({target:{value:0},duration:Math.floor(this.settings.targetFPS/2),mode:"EaseInOut",algo:"Quadratic",props:{value:1},onTweenUpdate:function(e){CanvasCycle.globalBrightness=e.target.value},category:"scenefade"})),this.inGame||(this.inGame=!0,this.animate()),this.startSceneAudio()}},animate:function(){if(this.inGame){var e=this.bmp.palette.colors;if(this.settings.showOptions){for(var t=0,s=e.length;s>t;t++){var i=e[t],n=$("pal_"+t);n.style.backgroundColor="rgb("+i.red+","+i.green+","+i.blue+")"}this.clock%this.settings.targetFPS==0&&($("d_debug").innerHTML="FPS: "+FrameCount.current)}this.bmp.palette.cycle(this.bmp.palette.baseColors,GetTickCount(),this.settings.speedAdjust,this.settings.blendShiftEnabled),this.highlightColor>-1&&(this.bmp.palette.colors[this.highlightColor]=new Color(255,255,255)),this.globalBrightness<1&&this.bmp.palette.burnOut(1-this.globalBrightness,1),this.bmp.render(this.imageData,this.lastBrightness==this.globalBrightness&&this.highlightColor==this.lastHighlightColor),this.lastBrightness=this.globalBrightness,this.lastHighlightColor=this.highlightColor,this.ctx.putImageData(this.imageData,0,0),TweenManager.logic(this.clock),this.clock++,FrameCount.count(),this.clock>100&&this.clock<110&&(encoder.addFrame(this.ctx),console.log("added frame")),this.inGame&&setTimeout(function(){CanvasCycle.animate()},1e3/this.settings.targetFPS)}},scaleAnimate:function(){if(this.settings.zoomFull){var e=this.contentSize.width+this.contentSize.optionsWidth,t=(this.winSize.width-30)/e,s=this.contentSize.height,i=(this.winSize.height-30)/s,n=Math.min(t,i);if(this.contentSize.scale!=n){this.contentSize.scale+=(n-this.contentSize.scale)/8,Math.abs(this.contentSize.scale-n)<.001&&(this.contentSize.scale=n);var a=$("mycanvas").style;ua.webkit?a.webkitTransform="translate3d(0px, 0px, 0px) scale("+this.contentSize.scale+")":ua.ff?a.MozTransform="scale("+this.contentSize.scale+")":ua.op?a.OTransform="scale("+this.contentSize.scale+")":a.transform="scale("+this.contentSize.scale+")",a.marginRight=""+Math.floor(this.contentSize.width*this.contentSize.scale-this.contentSize.width)+"px",$("d_header").style.width=""+Math.floor(this.contentSize.width*this.contentSize.scale)+"px",this.repositionContainer()}}else if(this.contentSize.scale>1){this.contentSize.scale+=(1-this.contentSize.scale)/8,this.contentSize.scale<1.001&&(this.contentSize.scale=1);var a=$("mycanvas").style;ua.webkit?a.webkitTransform="translate3d(0px, 0px, 0px) scale("+this.contentSize.scale+")":ua.ff?a.MozTransform="scale("+this.contentSize.scale+")":ua.op?a.OTransform="scale("+this.contentSize.scale+")":a.transform="scale("+this.contentSize.scale+")",a.marginRight=""+Math.floor(this.contentSize.width*this.contentSize.scale-this.contentSize.width)+"px",$("d_header").style.width=""+Math.floor(this.contentSize.width*this.contentSize.scale)+"px",this.repositionContainer()}},repositionContainer:function(){var e=$("container");e&&(this.winSize=getInnerWindowSize(),e.style.left=""+Math.floor(this.winSize.width/2-(this.contentSize.width*this.contentSize.scale+this.contentSize.optionsWidth)/2)+"px",e.style.top=""+Math.floor(this.winSize.height/2-this.contentSize.height*this.contentSize.scale/2)+"px")},handleResize:function(){this.repositionContainer(),this.settings.zoomFull&&this.scaleAnimate()},saveSettings:function(){this.cookie.set("settings",this.settings),this.cookie.save()},startSceneAudio:function(){var e=scenes[this.sceneIdx];if(e.sound&&this.settings.sound&&window.Audio){if(this.audioTrack)try{this.audioTrack.pause()}catch(t){}TweenManager.removeAll({category:"audio"});var s=ua.ff||ua.op?"ogg":"mp3",i=this.audioTrack=new Audio("audio/"+e.sound+"."+s);i.volume=0,i.loop=!0,i.autobuffer=!1,i.autoplay=!0,i.addEventListener("canplaythrough",function(){i.play(),TweenManager.tween({target:i,duration:Math.floor(2*CanvasCycle.settings.targetFPS),mode:"EaseOut",algo:"Linear",props:{volume:e.maxVolume||CanvasCycle.defaultMaxVolume},category:"audio"})},!1),(ua.iphone||ua.ipad)&&setTimeout(function(){i.play(),i.volume=1},1e3),(ua.ff||ua.mobile)&&i.addEventListener("ended",function(){i.currentTime=0,i.play()},!1),i.load()}},stopSceneAudio:function(){var e=scenes[this.sceneIdx];if(e.sound&&this.settings.sound&&window.Audio&&this.audioTrack){var t=this.audioTrack;ua.iphone||ua.ipad?t.pause():(TweenManager.removeAll({category:"audio"}),TweenManager.tween({target:t,duration:Math.floor(CanvasCycle.settings.targetFPS/2),mode:"EaseOut",algo:"Linear",props:{volume:0},onTweenComplete:function(e){t.pause()},category:"audio"}))}},toggleOptions:function(){var e,t;TweenManager.removeAll({category:"options"}),this.settings.showOptions?(e=1,this.optTween&&(e=this.optTween.target.value),t=0,$("btn_options_toggle").innerHTML="Show Options &#x00BB;"):(e=0,this.optTween&&(e=this.optTween.target.value),t=1,$("d_options").style.display="",$("d_options").style.opacity=e,$("btn_options_toggle").innerHTML="&#x00AB; Hide Options"),this.optTween=TweenManager.tween({target:{value:e},duration:Math.floor(this.settings.targetFPS/3),mode:"EaseOut",algo:"Quadratic",props:{value:t},onTweenUpdate:function(e){$("d_options").style.opacity=e.target.value,$("btn_options_toggle").style.left=""+Math.floor(128*e.target.value)+"px",CanvasCycle.contentSize.optionsWidth=Math.floor(150*e.target.value),CanvasCycle.handleResize()},onTweenComplete:function(e){0==e.target.value&&($("d_options").style.display="none"),CanvasCycle.optTween=null},category:"options"}),this.settings.showOptions=!this.settings.showOptions,this.saveSettings()},setZoom:function(e){e!=this.settings.zoomFull&&(this.settings.zoomFull=e,this.saveSettings(),$("btn_zoom_actual").setClass("selected",!e),$("btn_zoom_max").setClass("selected",e))},setSound:function(e){$("btn_sound_on").setClass("selected",e),$("btn_sound_off").setClass("selected",!e),this.settings.sound=e,this.sceneIdx>-1&&(e?this.audioTrack?this.audioTrack.play():this.startSceneAudio():this.audioTrack&&this.audioTrack.pause()),this.saveSettings()},setRate:function(e){this.settings.targetFPS=e,this.saveSettings()},setSpeed:function(e){$("btn_speed_025").setClass("selected",.25==e),$("btn_speed_05").setClass("selected",.5==e),$("btn_speed_1").setClass("selected",1==e),$("btn_speed_2").setClass("selected",2==e),$("btn_speed_4").setClass("selected",4==e),this.settings.speedAdjust=e,this.saveSettings()},setBlendShift:function(e){$("btn_blendshift_on").setClass("selected",e),$("btn_blendshift_off").setClass("selected",!e),this.settings.blendShiftEnabled=e,this.saveSettings()}},CC=CanvasCycle;