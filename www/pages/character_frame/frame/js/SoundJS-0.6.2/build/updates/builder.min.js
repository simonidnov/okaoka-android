var marked=require("marked"),fs=require("graceful-fs"),noop=function(){},path=require("path"),TEMPLATE;YUI.add("doc-builder",function(e){var t=e.Lang.fixType,s=function(t){var i="<ul>";return e.each(t,function(t,n){i+="<li>",e.Lang.isObject(t)&&(i+=t.path?'<a href="../files/'+t.name+'.html">'+n+"</a>":n+"/"+s(t)),i+="</li>"}),i+="</ul>"};e.Handlebars.registerHelper("buildFileTree",function(e){return s(e)});var i=path.join(__dirname,"../","themes","default"),n=i;e.DocBuilder=function(t,s){this.options=t,t.helpers&&this._addHelpers(t.helpers),t.themedir&&(n=t.themedir),this.data=s,e.log("Building..","info","builder"),this.files=0;var i=this;e.Handlebars.registerHelper("crossLink",function(t,s){var n="";if(t||(t=""),t.indexOf("|")>0){var a=t.split("|"),r=[];e.each(a,function(e){r.push(i._parseCrossLink.call(i,e))}),n=r.join(" | ")}else n=i._parseCrossLink.call(i,t,!1,s.fn(this));return n}),e.Handlebars.registerHelper("crossLinkModule",function(e,t){var s=e;if(i.data.modules[e]){var n=t.fn(this);""===n&&(n=e),s='<a href="../modules/'+e.replace(/\//g,"_")+'.html">'+n+"</a>"}return s}),e.Handlebars.registerHelper("crossLinkRaw",function(t){var s="";if(t||(t=""),t.indexOf("|")>0){var n=t.split("|"),a=[];e.each(n,function(e){a.push(i._parseCrossLink.call(i,e,!0))}),s=a.join(" | ")}else s=i._parseCrossLink.call(i,t,!0);return s}),this.cacheTemplates=!0,t.cacheTemplates===!1&&(this.cacheTemplates=!1)},e.DocBuilder.prototype={_addHelpers:function(t){e.log("Importing helpers: "+t,"info","builder"),t.forEach(function(t){(!e.Files.exists(t)||e.Files.exists(path.join(process.cwd(),t)))&&(t=path.join(process.cwd(),t));var s=require(t);Object.keys(s).forEach(function(t){e.Handlebars.registerHelper(t,s[t])})})},markdown:function(t){var s=marked(t,this.options.markdown);if(this.options.helpers||s.indexOf("{{#crossLink")>-1)try{s=s.replace(/&quot;/g,'"'),s=e.Handlebars.compile(s)({})}catch(i){s=s.replace(/\\{/g,"{").replace(/\\}/g,"}"),e.log("Failed to parse Handlebars, probably an unknown helper, skipping..","warn","builder")}return s},_parseCrossLink:function(s,i,n){var o,a=this,r="../",h=!1,A="crosslink";s=t(s),s=o=e.Lang.trim(s.replace("{","").replace("}","")),s=s.replace("*","").replace("[","").replace("]","");var l,g=!1;if(a.data.classes[s]?g=!0:a.data.classes[s.replace(".","")]&&(g=!0,s=s.replace(".","")),a.options.externalData&&a.data.classes[s]&&a.data.classes[s].external&&(l=a.data.classes[s].path,r=a.options.externalData.base,A+=" external",h=!0,g=!0),s.indexOf("/")>-1){var c=s.split("/"),u=c[0],p=c[1],f="method";p.indexOf(":")>-1&&(c=p.split(":"),p=c[0],f=c[1],0===f.indexOf("attr")&&(f="attribute")),u&&p&&a.data.classes[u]&&a.data.classitems.forEach(function(t){if(t.itemtype===f&&t.name===p&&t["class"]===u){g=!0,o=p;var s=f;"attribute"===s&&(s="attr"),l=e.webpath(r,"classes",u+".html#"+s+"_"+p)}})}return("Object"===s||"Array"===s)&&(g=!1),l||(l=e.webpath(r,"classes",s+".html"),r.match(/^https?:\/\//)&&(l=r+e.webpath("classes",s+".html"))),!g&&a.options.linkNatives&&a.NATIVES&&a.NATIVES[s]&&(l=a.NATIVES_LINKER(s),l&&(A+=" external",h=!0,g=!0)),g&&(void 0!==n&&(n=n.trim()),n||(n=o),s='<a href="'+l+'" class="'+A+'"'+(h?' target="_blank"':"")+">"+n+"</a>"),i?l:s},NATIVES:{Array:1,Boolean:1,Date:1,decodeURI:1,decodeURIComponent:1,encodeURI:1,encodeURIComponent:1,eval:1,Error:1,EvalError:1,Function:1,Infinity:1,isFinite:1,isNaN:1,Math:1,NaN:1,Number:1,Object:1,parseFloat:1,parseInt:1,RangeError:1,ReferenceError:1,RegExp:1,String:1,SyntaxError:1,TypeError:1,undefined:1,URIError:1,HTMLElement:"https://developer.mozilla.org/en/Document_Object_Model_(DOM)/",HTMLCollection:"https://developer.mozilla.org/en/Document_Object_Model_(DOM)/",DocumentFragment:"https://developer.mozilla.org/en/Document_Object_Model_(DOM)/",HTMLDocument:"https://developer.mozilla.org/en/Document_Object_Model_(DOM)/"},NATIVES_LINKER:function(e){var t="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/";return 1!==this.NATIVES[e]&&(t=this.NATIVES[e]),t+e},_mixExternal:function(){var s=this;e.log("External data received, mixing","info","builder"),s.options.externalData.forEach(function(i){["files","classes","modules"].forEach(function(n){e.each(i[n],function(e,a){e.external=!0;var r=e.name;e.file||(r=s.filterFileName(e.name)),e.type&&(e.type=t(e.type)),e.path=i.base+path.join(n,r+".html"),s.data[n][a]=e})}),e.each(i.classitems,function(e){e.external=!0,e.path=i.base+path.join("files",s.filterFileName(e.file)+".html"),e.type&&(e.type=t(e.type)),e.params&&e.params.forEach(function(e){e.type&&(e.type=t(e.type))}),e["return"]&&(e["return"].type=t(e["return"].type)),s.data.classitems.push(e)})})},mixExternal:function(t){var s=this,i=s.options.external;if(!i)return void t();if(i.merge||(i.merge="mix"),!i.data)return e.log("External config found but no data path defined, skipping import.","warn","builder"),void t();e.Lang.isArray(i.data)||(i.data=[i.data]),e.log("Importing external documentation data.","info","builder");var n=new e.Parallel;i.data.forEach(function(t){var i;if(t.match(/^https?:\/\//))i=t.replace("data.json",""),e.use("io-base",n.add(function(){e.log("Fetching: "+t,"info","builder"),e.io(t,{on:{complete:n.add(function(n,a){e.log("Received: "+t,"info","builder");var r=JSON.parse(a.responseText);r.base=i,s.options.externalData||(s.options.externalData=[]),s.options.externalData.push(r)})}})}));else{i=path.dirname(path.resolve(t));var a=e.Files.getJSON(t);a.base=i,s.options.externalData||(s.options.externalData=[]),s.options.externalData.push(a)}}),n.done(function(){e.log("Finished fetching remote data","info","builder"),s._mixExternal(),t()})},files:null,_meta:null,getProjectMeta:function(){var t={meta:{yuiSeedUrl:"http://yui.yahooapis.com/3.5.0/build/yui/yui-min.js",yuiGridsUrl:"http://yui.yahooapis.com/3.5.0/build/cssgrids/cssgrids-min.css"}};if(this._meta)t.meta=this._meta;else try{var s,a=path.join(n,"theme.json");e.Files.exists(a)?(e.log("Loading theme from "+a,"info","builder"),s=e.Files.getJSON(a)):i!==n&&(a=path.join(i,"theme.json"),e.Files.exists(a)&&(e.log("Loading theme from "+a,"info","builder"),s=e.Files.getJSON(a))),s&&(t.meta=s,this._meta=s)}catch(r){console.error("Error",r)}return e.each(this.data.project,function(e,s){var i=s.substring(0,1).toUpperCase()+s.substring(1,s.length);t.meta["project"+i]=e}),t},populateClasses:function(t){return t.meta.classes=[],e.each(this.data.classes,function(e){e.external||t.meta.classes.push({displayName:e.name,name:e.name,namespace:e.namespace,module:e.module,description:e.description,access:e.access||"public"})}),t.meta.classes.sort(this.nameSort),t},populateModules:function(t){var s=this;return t.meta.modules=[],t.meta.allModules=[],e.each(this.data.modules,function(i){if(!i.external&&(t.meta.allModules.push({displayName:i.displayName||i.name,name:s.filterFileName(i.name),description:i.description}),!i.is_submodule)){var n={displayName:i.displayName||i.name,name:s.filterFileName(i.name)};i.submodules&&(n.submodules=[],e.each(i.submodules,function(e,t){var i=s.data.modules[t];i&&n.submodules.push({displayName:t,description:i.description})}),n.submodules.sort(s.nameSort)),t.meta.modules.push(n)}}),t.meta.modules.sort(this.nameSort),t.meta.allModules.sort(this.nameSort),t},populateFiles:function(t){var s=this;t.meta.files=[],e.each(this.data.files,function(e){e.external||t.meta.files.push({displayName:e.name,name:s.filterFileName(e.name),path:e.path||e.name})});var i={},n=[];return e.each(this.data.files,function(e){e.external||n.push(e.name)}),n.sort(),e.each(n,function(e){var n,t=e.split("/");t.forEach(function(a,r){n?(n[a]||(n[a]={}),r+1===t.length&&(n[a]={path:e,name:s.filterFileName(e)}),n=n[a]):(i[a]||(i[a]={}),n=i[a])})}),t.meta.fileTree=i,t},addFoundAt:function(e){var t=this;return e.file&&e.line&&!t.options.nocode&&(e.foundAt="../files/"+t.filterFileName(e.file)+".html#l"+e.line,e.path&&(e.foundAt=e.path+"#l"+e.line)),e},augmentData:function(t){var s=this;return t=s.addFoundAt(t),e.each(t,function(i,n){i&&i.forEach?e.each(i,function(i,a){i instanceof Object&&(i.type||(i.type="Object"),""===i["final"]&&(i["final"]=!0),i.description?i.description=s.markdown(i.description):i.description=" ",i.example&&(i.example=s.markdown(i.example)),i=s.addFoundAt(i),e.each(i,function(e,t){(e.forEach||e instanceof Object)&&(e=s.augmentData(e),i[t]=e)}),t[n][a]=i)}):i instanceof Object?(i=s.addFoundAt(i),e.each(i,function(e,i){"final"===i&&(t[n][i]=!0),("description"===i||"example"===i)&&("return"===n?t[n][i]=s.markdown(e):e.forEach||e instanceof Object?t[n][i]=s.augmentData(e):t[n][i]=s.markdown(e))})):("description"===n||"example"===n)&&(t[n]=s.markdown(i))}),t},makeDirs:function(t){var s=this,i=["classes","modules","files"];s.options.dumpview&&i.push("json");var a=function(t,s,i){e.Files.exists(s,function(e){if(e){var n=path.join(t,"index.html");fs.createReadStream(s).pipe(fs.createWriteStream(n))}i()})},r=path.join(n,"assets","index.html"),o=new e.Parallel;e.log("Making default directories: "+i.join(","),"info","builder"),i.forEach(function(t){var i=path.join(s.options.outdir,t);e.Files.exists(i,o.add(function(e){e?a(i,r,o.add(noop)):fs.mkdir(i,511,o.add(function(){a(i,r,o.add(noop))}))}))}),o.done(function(){t&&t()})},_resolveUrl:function(e,t){return e?e.indexOf("://")>=0?e:path.join(t.meta.projectRoot,e):null},_parseCode:function(e){return e=e||"",e=e.replace(/<pre><code/g,'<pre class="code prettyprint"><code')},_inlineCode:function(t){return t=t.replace(/\\`/g,"__{{SELLECK_BACKTICK}}__"),t=t.replace(/`(.+?)`/g,function(t,s){return"<code>"+e.escapeHTML(s)+"</code>"}),t=t.replace(/__\{\{SELLECK_BACKTICK\}\}__/g,"`")},render:function(t,s,i,n,a){var r=[];"function"==typeof n?(a=n,n={}):"function"==typeof i&&(a=i,i=null);var o=e.merge(n||{},{layout_content:t});e.each(o,function(t,s){e.Handlebars.registerPartial(s,t)}),TEMPLATE&&this.cacheTemplates||(TEMPLATE=e.Handlebars.compile(i));var h={};for(var A in s)e.Lang.isFunction(s[A])?h[A]=s[A]():h[A]=s[A];r=TEMPLATE(h),r=this._inlineCode(r),a(null,r)},renderIndex:function(t){var s=this;e.prepare([i,n],s.getProjectMeta(),function(i,n){n.meta.title=s.data.project.name,n.meta.projectRoot="./",n.meta.projectAssets="./assets",n.meta.projectLogo=s._resolveUrl(s.data.project.logo,n),n=s.populateClasses(n),n=s.populateModules(n);var a=new e.DocView(n.meta);s.render("{{>index}}",a,n.layouts.main,n.partials,function(e,i){s.files++,t(i,a)})})},writeIndex:function(t){var s=this,i=new e.Parallel;e.log("Preparing index.html","info","builder"),s.renderIndex(i.add(function(t,n){i.html=t,i.view=n,s.options.dumpview&&e.Files.writeFile(path.join(s.options.outdir,"json","index.json"),JSON.stringify(n),i.add(noop)),e.Files.writeFile(path.join(s.options.outdir,"index.html"),t,i.add(noop))})),i.done(function(){e.log("Writing index.html","info","builder"),t(i.html,i.view)})},renderModule:function(t,s,a){var r=this,o=new e.Parallel;s.displayName=s.name,s.name=r.filterFileName(s.name),e.prepare([i,n],r.getProjectMeta(),function(t,i){if(i.meta=e.merge(i.meta,s),i.meta.title=r.data.project.name,i.meta.moduleName=s.displayName||s.name,i.meta.moduleDescription=r._parseCode(r.markdown(s.description||" ")),i.meta.file=s.file,i.meta.line=s.line,i.meta=r.addFoundAt(i.meta),i.meta.projectRoot="../",i.meta.projectAssets="../assets",i.meta.projectLogo=r._resolveUrl(r.data.project.logo,i),i=r.populateClasses(i),i=r.populateModules(i),i=r.populateFiles(i),s.classes&&Object.keys(s.classes).length&&(i.meta.moduleClasses=[],e.each(Object.keys(s.classes),function(e){var t=r.data.classes[e];t&&i.meta.moduleClasses.push({name:t.name,displayName:t.name})}),i.meta.moduleClasses.sort(r.nameSort)),s.example&&s.example.length){if(s.example.forEach){var n="";s.example.forEach(function(e){n+=r._parseCode(r.markdown(e))}),s.example=n}else s.example=r._parseCode(r.markdown(s.example));i.meta.example=s.example}s.submodules&&Object.keys(s.submodules).length&&(i.meta.subModules=[],e.each(Object.keys(s.submodules),function(e){var t=r.data.modules[e];t&&i.meta.subModules.push({name:t.name,displayName:t.name,description:t.description})}),i.meta.subModules.sort(r.nameSort));var h=new e.DocView(i.meta),A=i.layouts[a];r.render("{{>module}}",h,A,i.partials,o.add(function(e,t){r.files++,o.html=t,o.view=h}))}),o.done(function(){t(o.html,o.view)})},writeModules:function(t,s){s=s||"main";var i=this,n=new e.Parallel;n.html=[],n.view=[];var a=0;Object.keys(i.data.modules).forEach(function(e){i.data.modules[e].external||a++}),e.log("Rendering and writing "+a+" modules pages.","info","builder"),e.each(i.data.modules,function(t){t.external||i.renderModule(function(s,a){n.html.push(s),n.view.push(a),i.options.dumpview&&e.Files.writeFile(path.join(i.options.outdir,"json","module_"+t.name+".json"),JSON.stringify(a),n.add(noop)),e.Files.writeFile(path.join(i.options.outdir,"modules",t.name+".html"),s,n.add(noop))},t,s)}),n.done(function(){e.log("Finished writing module files","info","builder"),t(n.html,n.view)})},hasProperty:function(t,s){var i=!1;return e.some(t,function(e,t){return e.itemtype===s.itemtype&&e.name===s.name?(i=t,!0):void 0}),i},_mergeCounter:null,mergeExtends:function(t,s,i){var n=this;if(n._mergeCounter=i?0:n._mergeCounter+1,100===n._mergeCounter)throw"YUIDoc detected a loop extending class "+t.name;if(t["extends"]||t.uses){var a={};a[t["extends"]]=1,t.uses&&t.uses.forEach(function(e){a[e]=1}),n.data.classitems.forEach(function(t){if(a[t["class"]]&&!t["static"]){var i,r=n.hasProperty(s,t);r===!1?(i=e.merge({},t),i.extended_from=t["class"],s.push(i)):(i=e.merge({},t),i=n.augmentData(i),s[r].overwritten_from=i)}}),n.data.classes[t["extends"]]&&(n.data.classes[t["extends"]]["extends"]||n.data.classes[t["extends"]].uses)&&(s=n.mergeExtends(n.data.classes[t["extends"]],s))}return s},renderClass:function(t,s,a){var r=this,o=new e.Parallel;e.prepare([i,n],r.getProjectMeta(),function(t,i){t&&console.log(t),i.meta=e.merge(i.meta,s),i.meta.title=r.data.project.name,i.meta.moduleName=s.name,i.meta.file=s.file,i.meta.line=s.line,i.meta=r.addFoundAt(i.meta),i.meta.projectRoot="../",i.meta.projectAssets="../assets",i.meta.projectLogo=r._resolveUrl(r.data.project.logo,i),i=r.populateClasses(i),i=r.populateModules(i),i=r.populateFiles(i),i.meta.classDescription=r._parseCode(r.markdown(s.description||" ")),i.meta.methods=[],i.meta.properties=[],i.meta.attrs=[],i.meta.events=[],i.meta.extension_for=null,s.uses&&(i.meta.uses=s.uses),s.entension_for&&s.extension_for.length&&(i.meta.extension_for=s.extension_for),s["extends"]&&(i.meta["extends"]=s["extends"]);var n=[];if(r.data.classitems.forEach(function(e){e["class"]===s.name&&n.push(e)}),n=r.mergeExtends(s,n,!0),s.is_constructor){var h=e.mix({},s);if(h=r.augmentData(h),h.paramsList=[],h.params&&h.params.forEach(function(e){var t=e.name;e.optional&&(t="["+t+(e.optdefault?"="+e.optdefault:"")+"]"),h.paramsList.push(t)}),h.hasAccessType=h.access,h.hasParams=h.paramsList.length,h.paramsList.length?h.paramsList=h.paramsList.join(", "):h.paramsList=" ",h.returnType=" ",h["return"]&&(h.hasReturn=!0,h.returnType=h["return"].type),i.meta.is_constructor=[h],h.example&&h.example.length)if(h.example.forEach){var A="";h.example.forEach(function(e){A+=r._parseCode(r.markdown(e))}),h.example=A}else h.example=r._parseCode(r.markdown(h.example))}n.forEach(function(e){var t;switch(e.itemtype){case"method":e=r.augmentData(e),e.paramsList=[],e.params&&e.params.forEach&&e.params.forEach(function(t){var s=t.name;t.optional&&(s="["+s+(t.optdefault?"="+t.optdefault:"")+"]"),e.paramsList.push(s)}),e.methodDescription=r._parseCode(e.description),e.example&&e.example.length&&(e.example.forEach?(t="",e.example.forEach(function(e){t+=r._parseCode(r.markdown(e))}),e.example=t):e.example=r._parseCode(r.markdown(e.example))),e.hasAccessType=e.access,e.hasParams=e.paramsList.length,e.paramsList.length?e.paramsList=e.paramsList.join(", "):e.paramsList=" ",e.returnType=" ",e["return"]&&(e.hasReturn=!0,e.returnType=e["return"].type),(e.submodule||e.module)!==(s.submodule||s.module)&&(e.providedBy=e.submodule||e.module),i.meta.methods.push(e);break;case"property":e=r.augmentData(e),e.propertyDescription=r._parseCode(e.description),e.type||(e.type="unknown"),""===e["final"]&&(e["final"]=!0),""===e.readonly&&(e.readonly=!0),e.example&&e.example.length&&(e.example.forEach?(t="",e.example.forEach(function(e){t+=r._parseCode(r.markdown(e))}),e.example=t):e.example=r._parseCode(r.markdown(e.example))),(e.submodule||e.module)!==(s.submodule||s.module)&&(e.providedBy=e.submodule||e.module),i.meta.properties.push(e);break;case"attribute":case"config":e=r.augmentData(e),e.attrDescription=r._parseCode(e.description),"config"===e.itemtype?e.config=!0:e.emit=r.options.attributesEmit,""===e.readonly&&(e.readonly=!0),e.example&&e.example.length&&(e.example.forEach?(t="",e.example.forEach(function(e){t+=r._parseCode(r.markdown(e))}),e.example=t):e.example=r._parseCode(r.markdown(e.example))),(e.submodule||e.module)!==(s.submodule||s.module)&&(e.providedBy=e.submodule||e.module),i.meta.attrs.push(e);break;case"event":e=r.augmentData(e),e.eventDescription=r._parseCode(e.description),e.example&&e.example.length&&(e.example.forEach?(t="",e.example.forEach(function(e){t+=r._parseCode(r.markdown(e))}),e.example=t):e.example=r._parseCode(r.markdown(e.example))),(e.submodule||e.module)!==(s.submodule||s.module)&&(e.providedBy=e.submodule||e.module),i.meta.events.push(e)}}),i.meta.attrs.sort(r.nameSort),i.meta.events.sort(r.nameSort),i.meta.methods.sort(r.nameSort),i.meta.properties.sort(r.nameSort),i.meta.methods.length||delete i.meta.methods,i.meta.properties.length||delete i.meta.properties,i.meta.attrs.length||delete i.meta.attrs,i.meta.events.length||delete i.meta.events;var g=new e.DocView(i.meta),l=i.layouts[a];r.render("{{>classes}}",g,l,i.partials,o.add(function(e,t){r.files++,o.html=t,o.view=g,o.opts=i}))}),o.done(function(){t(o.html,o.view,o.opts)})},writeClasses:function(t,s){s=s||"main";var i=this,n=new e.Parallel;n.html=[],n.view=[];var a=0;Object.keys(i.data.classes).forEach(function(e){i.data.classes[e].external||a++}),e.log("Rendering and writing "+a+" class pages.","info","builder"),e.each(i.data.classes,function(t){t.external||i.renderClass(n.add(function(s,a){n.html.push(s),n.view.push(a),i.options.dumpview&&e.Files.writeFile(path.join(i.options.outdir,"json","classes_"+t.name+".json"),JSON.stringify(a),n.add(noop)),e.Files.writeFile(path.join(i.options.outdir,"classes",t.name+".html"),s,n.add(noop))}),t,s)}),n.done(function(){e.log("Finished writing class files","info","builder"),t(n.html,n.view)})},nameSort:function(e,t){if(!e.name||!t.name)return 0;var s=e.name.toLowerCase(),i=t.name.toLowerCase(),n=0;return i>s&&(n=-1),s>i&&(n=1),n},writeFiles:function(t,s){s=s||"main";var i=this,n=new e.Parallel;n.html=[],n.view=[];var a=0;Object.keys(i.data.files).forEach(function(e){i.data.files[e].external||a++}),e.log("Rendering and writing "+a+" source files.","info","builder"),e.each(i.data.files,function(t){t.external||i.renderFile(n.add(function(t,s,a){s&&a&&(n.html.push(t),n.view.push(s),i.options.dumpview&&e.Files.writeFile(path.join(i.options.outdir,"json","files_"+i.filterFileName(a.name)+".json"),JSON.stringify(s),n.add(noop)),e.Files.writeFile(path.join(i.options.outdir,"files",i.filterFileName(a.name)+".html"),t,n.add(noop)))}),t,s)}),n.done(function(){e.log("Finished writing source files","info","builder"),t(n.html,n.view)})},renderFile:function(t,s,a){var r=this;e.prepare([i,n],r.getProjectMeta(),function(i,n){i&&console.log(i),s.name&&(n.meta=e.merge(n.meta,s),n.meta.title=r.data.project.name,n.meta.moduleName=s.name,n.meta.projectRoot="../",n.meta.projectAssets="../assets",n.meta.projectLogo=r._resolveUrl(r.data.project.logo,n),n=r.populateClasses(n),n=r.populateModules(n),n=r.populateFiles(n),n.meta.fileName=s.name,fs.readFile(n.meta.fileName,e.charset,e.rbind(function(s,i,n,o){if(s)return e.log(s,"error","builder"),void t(s);"string"==typeof r.options.tabspace&&(i=i.replace(/\t/g,r.options.tabspace)),n.meta.fileData=i;var h=new e.DocView(n.meta,"index"),A=n.layouts[a];r.render("{{>files}}",h,A,n.partials,function(e,s){r.files++,t(s,h,o)})},this,n,s)))})},writeAPIMeta:function(t){e.log("Writing API Meta Data","info","builder");var s=this;this.renderAPIMeta(function(i){fs.writeFile(path.join(s.options.outdir,"api.js"),i,e.charset,t)})},renderAPIMeta:function(e){var t={meta:{}};t=this.populateClasses(t),t=this.populateModules(t),["classes","modules"].forEach(function(e){t.meta[e].forEach(function(s,i){t.meta[e][i]=s.name,s.submodules&&s.submodules.forEach(function(s){t.meta[e].push(s.displayName)})}),t.meta[e].sort()});var s='YUI.add("yuidoc-meta", function(Y) {\n   Y.YUIDoc = { meta: '+JSON.stringify(t.meta,null,4)+" };\n});";e(s)},filterFileName:function(e){return e.replace(/[\/\\]/g,"_")},compile:function(t){var s=this,a=(new Date).getTime();e.log("Compiling Templates","info","builder"),this.mixExternal(function(){s.makeDirs(function(){e.log("Copying Assets","info","builder"),e.Files.isDirectory(path.join(s.options.outdir,"assets"))||fs.mkdirSync(path.join(s.options.outdir,"assets"),511),e.Files.copyAssets([path.join(i,"assets"),path.join(n,"assets")],path.join(s.options.outdir,"assets"),!1,function(){var i=new e.Parallel;s.writeModules(i.add(function(){s.writeClasses(i.add(function(){s.options.nocode||s.writeFiles(i.add(noop))}))})),s.writeIndex(i.add(noop)),s.writeAPIMeta(i.add(noop)),i.done(function(){var i=(new Date).getTime(),n=(i-a)/1e3+" seconds";e.log("Finished writing "+s.files+" files in "+n,"info","builder"),t&&t()})})})})}}});