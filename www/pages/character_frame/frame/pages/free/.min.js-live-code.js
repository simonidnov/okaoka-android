function free(){_free=this,this._containers=[],this._linkers=[],this._visual_links=null,this._current_evt=null,this._selected_link=0,this._link_infos={start:{},end:{}},this.mouse={x:0,y:0},this._nav=null,this._free_contents=null}function sqr(e){return e*e}var _free;free.prototype.init=function(){this.stage=new createjs.Stage("free_canvas"),$("#free_canvas").css({width:window.innerWidth,height:window.innerHeight}),$("#free_canvas").attr({width:window.innerWidth,height:window.innerHeight}),this.stage.autoClear=!0,createjs.Touch.enable(this.stage),ground=new createjs.Shape,ground.graphics.beginStroke("black").beginFill("white").drawRect(0,0,window.innerWidth,window.innerHeight),ground.name="ground",this.stage.addChild(ground),this._free_contents=new createjs.Container,this.stage.addChild(this._free_contents),this._visual_links=new createjs.Container,this.stage.addChild(this._visual_links),this.stage.update(),createjs.Ticker.addEventListener("tick",this.ticker),createjs.Ticker.setFPS(60),$(window).on("mousemove",function(e){_free.mouse.x=e.clientX,_free.mouse.y=e.clientY}),this.create_nav(),$("#carre").on("click",function(){_free.add_shape()})},free.prototype.create_button=function(e,t,s){var i=new createjs.Container;i.name=s;var n=new createjs.Shape;n.graphics.beginFill("red").drawCircle(0,0,30),i.addChild(n);var a=new createjs.LoadQueue(!0);a.on("complete",function(e){var s=new createjs.Bitmap(t);s.scaleX=s.scaleY=.8,s.x=s.y=-25,s.mouseEnabled=!1,i.addChild(s)},this),a.loadFile(t),a.load(),e.addChild(i)},free.prototype.open_nav=function(e,t){if("closed"===_free.nav_style)return!1;this._display_nav.alpha=1,this._display_nav.graph.graphics.clear(),this._display_nav.graph.graphics.beginFill("red").drawCircle(0,0,5),this._display_nav.x=e,this._display_nav.y=t;var s=this._display_nav.buttons.getNumChildren(),i=0,n=2*Math.PI/s;TweenLite.to(_free._display_nav,.2,{scaleX:1,scaleY:1,alpha:1});for(var a=0;a<this._display_nav.buttons.getNumChildren();a++){var e=80*Math.cos(i),t=80*Math.sin(i);i+=n,TweenLite.set(this._display_nav.buttons.getChildAt(a),{scaleX:0,scaleY:0}),TweenLite.to(this._display_nav.buttons.getChildAt(a),.5,{x:e,y:t,scaleX:1,scaleY:1,delay:.1*a})}},free.prototype.close_nav=function(){_free.nav_style="closed";for(var e=0;e<this._display_nav.buttons.getNumChildren();e++)TweenLite.to(this._display_nav.buttons.getChildAt(e),.5,{x:0,y:0,scaleX:0,scaleY:0,delay:.05*e});TweenLite.to(_free._display_nav,.5,{scaleX:0,scaleY:0,alpha:0,delay:.1*this._display_nav.buttons.getNumChildren()+.5,onComplete:function(){_free._display_nav.graph.graphics.clear(),_free.nav_style="null"}})},free.prototype.hello=function(){alert("hello")},free.prototype.create_nav=function(){this._nav=new createjs.Container,this.stage.addChild(this._nav),this._display_nav=new createjs.Container,this._display_nav.alpha=0,this._display_nav.x=this._display_nav.y=100,this.stage.addChild(this._display_nav),this._display_nav.graph=new createjs.Shape,this._display_nav.graph.name="graph",this._display_nav.addChild(this._display_nav.graph),this._display_nav.buttons=new createjs.Container,this._display_nav.buttons.name="buttons",this._display_nav.addChild(this._display_nav.buttons),this.create_button(this._display_nav.buttons,"/images/assets/assets_delete_icon.png","delete_button"),this.create_button(this._display_nav.buttons,"/images/assets/assets_edit_icon.png","edit_button"),this.create_button(this._display_nav.buttons,"/images/assets/assets_move_icon.png","move_button"),console.log(this),this.create_button(this._display_nav.buttons,"/images/assets/assets_rotate_icon.png","rotate_button"),this.create_button(this._display_nav.buttons,"/images/assets/assets_link_icon.png","link_button"),this.create_button(this._display_nav.buttons,"/images/assets/assets_close_icon.png","close_button"),this._display_nav.on("click",function(e){switch(-1!==e.target.parent.name.indexOf("button")&&_free.close_nav(),e.target.parent.name){case"close_button":_free.mode="null";break;case"edit_button":alert("edit function is on progress"),_free.mode="edit";break;case"move_button":_free.mode="move";break;case"link_button":_free.mode="linker";break;case"rotate_button":_free.mode="rotation";break;case"delete_button":alert("delete function is on progress")}}),this.stage.on("mousedown",function(e){}),carre=new createjs.Shape,carre.graphics.beginStroke("black").beginFill("white").drawRect(0,0,120,120),carre.regX=carre.regY=carre.x=carre.y=60,this._nav.addChild(carre),this._nav.setBounds(0,0,120,120),carre.on("pressmove",function(e){_free.close_nav(),_free.mode="shaper",e.target.x=e.stageX-_free._nav.x,e.target.y=e.stageY-_free._nav.y}),carre.on("pressup",function(e){_free.mode="shaper",TweenLite.to(carre,.5,{x:60,y:60}),_free.add_shape({x:e.stageX,y:e.stageY,width:120,height:120,type:"rectangle"})}),this._nav.x=200,this._nav.y=window.innerHeight-120},free.prototype.add_shape=function(e){var t=this._containers.length;this._containers[t]=new createjs.Container,this._free_contents.addChild(this._containers[t]),decoupe=new createjs.Shape,decoupe.name="decoupe",decoupe.graphics.setStrokeStyle(.1).beginStroke("red").beginFill("rgba(255,255,255,.1)").drawRect(0,0,e.width,e.height),this._containers[t].addChild(decoupe),gravure=new createjs.Shape,gravure.name="gravure",gravure.graphics.beginStroke("black").beginFill("rgba(0,255,255,.1)").drawRect(0,0,e.width,e.height),this._containers[t].addChild(gravure),gravure.mask=decoupe,this._containers[t].name="container_"+t,this._containers[t].setBounds(0,0,e.width,e.height),this._containers[t].x=e.x,this._containers[t].y=e.y,this._containers[t].regX=e.width/2,this._containers[t].regY=e.height/2,this._containers[t].on("click",function(e){-1!==e.target.parent.name.indexOf("container_")&&_free.open_nav(e.target.parent.x,e.target.parent.y)}),this.stage.enableMouseOver();var s={x:0,y:0,rotation:0};this._containers[t].on("mouseover",function(e){"linker"===_free.mode&&(_free._current_evt=e)}),this._containers[t].on("mousedown",function(e){"linker"===_free.mode?_free.add_link(e):"rotation"===_free.mode?s.rotation=e.target.parent.rotation:s={x:_free.mouse.x,y:_free.mouse.y}}),this.pos_angle=new createjs.Shape,this.stage.addChild(this.pos_angle),_free.text=new createjs.Text,_free.stage.addChild(_free.text),this._containers[t].on("pressmove",function(e){if(_free.close_nav(),"move"===_free.mode)e.target.parent.x=e.stageX,e.target.parent.y=e.stageY;else if("rotation"===_free.mode){_free.pos_angle.graphics.clear(),_free.pos_angle.graphics.beginFill("red").drawCircle(e.target.parent.x,e.target.parent.y,5),_free.pos_angle.graphics.endFill(),_free.pos_angle.graphics.setStrokeStyle(3),_free.pos_angle.graphics.beginStroke("red"),_free.pos_angle.graphics.moveTo(e.target.parent.x,e.target.parent.y),_free.pos_angle.graphics.lineTo(_free.mouse.x,_free.mouse.y),_free.pos_angle.graphics.endStroke();var t=_free.get_angle({x:e.target.parent.x,y:e.target.parent.y},{x:_free.mouse.x,y:_free.mouse.y})+s.rotation;t>360&&(t-=360),_free.text.text=Math.round(t),_free.text.x=e.target.parent.x,_free.text.y=e.target.parent.y,e.target.parent.rotation=t}}),this._containers[t].on("pressup",function(e){_free.pos_angle.graphics.clear(),_free.text.text="","linker"===_free.mode&&_free.set_link(e)})},free.prototype.add_link=function(e){var t=this._linkers.length;this._selected_link=t,this._linkers[t]={start:{x:e.stageX-e.target.parent.x+e.target.parent.regX,y:e.stageY-e.target.parent.y+e.target.parent.regY,element:null,evt:e,name:e.target.parent.name},end:{x:0,y:0,element:null,evt:null,name:""}},this.add_linker(t,this._linkers[t].start.x,this._linkers[t].start.y,e.target.parent,"start",e)},free.prototype.add_linker=function(e,t,s,i,n,a){this._linkers[e][n].x=t,this._linkers[e][n].y=s,this._linkers[e][n].evt=a,this._linkers[e][n].element=new createjs.Shape,this._linkers[e][n].element.graphics.beginStroke("black").beginFill("white").drawRect(0,0,20,20),this._linkers[e][n].element.regX=this._linkers[e][n].element.regY=10,this._linkers[e][n].name=a.target.parent.name,this._linkers[e][n].element.link_id=e,this._linkers[e][n].element.link_type=n,this._linkers[e][n].element.x=this._linkers[e][n].x,this._linkers[e][n].element.y=this._linkers[e][n].y,this._linkers[e][n].element.name="link",i.addChild(this._linkers[e][n].element);var r={x:0,y:0};this._linkers[e][n].element.on("mousedown",function(e){r.x=_free.mouse.x-e.target.parent.x,r.y=_free.mouse.y-e.target.parent.y}),this._linkers[e][n].element.on("pressmove",function(e){_free.close_nav();var t=e.target.parent,i=(t.rotation,_free.dist_angle(t,_free.mouse));e.target.x=i.x,e.target.y=i.y,_free.mode="move_link"}),this._linkers[e][n].element.on("pressup",function(e){_free.mode="move"})},free.prototype.select_link=function(e){},free.prototype.set_link=function(e){if(_free.mode="shaper","undefined"==typeof this._linkers[this._selected_link])return!1;if(-1===e.target.parent.name.indexOf("container_"))return this.delete_link(this._selected_link),!1;if(_free._current_evt.target.parent.name===this._linkers[this._selected_link].start.evt.target.parent.name)return this.delete_link(this._selected_link),!1;for(var t=0;t<this._linkers.length;t++){var s=this._linkers[t].start.name+""+this._linkers[t].end.name,i=this._current_evt.target.parent.name+""+this._linkers[this._selected_link].start.name,n=this._linkers[this._selected_link].start.name+""+this._current_evt.target.parent.name;if(s===i||s===n)return this.delete_link(this._selected_link),!1}this.add_linker(this._selected_link,e.stageX-this._current_evt.target.parent.x+this._current_evt.target.parent.regX,e.stageY-this._current_evt.target.parent.y+this._current_evt.target.parent.regY,this._current_evt.target.parent,"end",this._current_evt)},free.prototype.delete_link=function(e){this._linkers[e].start.element.parent.removeChild(this._linkers[e].start.element),this._linkers.splice(e,1)},free.prototype.get_angle=function(e,t){var s=t.x-e.x,i=t.y-e.y,n=Math.atan2(i,s),a=n+Math.PI;return 180*a/Math.PI},free.prototype.dist_angle=function(e,t){dx=t.x-(e.x-e.regX),dy=t.y-(e.y-e.regY),angle=e.rotation;var s=Math.sqrt(sqr(dx)+sqr(dy));Math.cos(angle*Math.PI/180)*s,Math.sin(angle*Math.PI/180)*s;return{x:dx,y:dy}},free.prototype.get_offset=function(e){var t=e.evt.target.parent,s=e.element,i=Math.sqrt(sqr(t.regX-s.x)+sqr(t.regY-s.y)),n=t.regX-s.x,a=t.regY-s.y,r=Math.atan2(a,n),o=r+Math.PI,h=180*o/Math.PI+t.rotation,A=Math.cos(h*Math.PI/180)*i+t.x,g=Math.sin(h*Math.PI/180)*i+t.y;return{x:A,y:g}},free.prototype.ticker=function(){var e=new createjs.Shape;_free._visual_links.removeChildAt(0),e.graphics.setStrokeStyle(3),e.graphics.beginStroke("black");for(var t=0;t<_free._linkers.length;t++){var s=_free.get_offset(_free._linkers[t].start);if(null!==_free._linkers[t].end.element){var i=_free.get_offset(_free._linkers[t].end);e.graphics.moveTo(s.x,s.y),e.graphics.lineTo(i.x,i.y)}else e.graphics.moveTo(s.x,s.y),e.graphics.lineTo(_free.mouse.x,_free.mouse.y)}e.graphics.endStroke(),_free._visual_links.addChild(e),_free.stage.update()},free.prototype.play=function(){},free.prototype.pause=function(){},free.prototype.update=function(){},free.prototype.refresh=function(e){},free.prototype.destroy=function(e){e()};