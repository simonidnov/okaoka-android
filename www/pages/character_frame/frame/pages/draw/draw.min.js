function draw(){if(_draw=this,this.stage=null,console.log("create new page script : ",app.page_properties),console.log("create new page _page_request : ",app._page_request),"undefined"!=typeof app._page_request.id){var e=JSON.parse(window.localStorage.getItem("containers"))[app._page_request.id];console.log("content ::: ",e)}}var stage,color,oldMidX,gravure,oldMidY,oldX,oldY,startX,startY,txt,currentShape,decoupe,isMouseDown,size,_draw=null,deleted_story={decoupes:[],gravures:[]};draw.prototype.init=function(){size=$(".draw li.active").attr("data-size"),colorer=$(".draw li.active").attr("data-color"),type=$(".draw li.active").attr("data-type"),$("#drawing_canvas").css({width:window.innerWidth,height:window.innerHeight}),$("#drawing_canvas").attr({width:window.innerWidth,height:window.innerHeight})},draw.prototype.transition_end=function(){console.log("transition_end"),$("#drawing_canvas").css({width:window.innerWidth,height:window.innerHeight}),$("#drawing_canvas").attr({width:window.innerWidth,height:window.innerHeight}),$(".brushes").css("display","block"),$(".prev_next_clear").css("display","table"),this.init_listeners(),this.init_drawing()},draw.prototype.init_listeners=function(){$(".draw li").on("click",function(e){switch($(this).attr("data-type")){case"brush":$(".brushes li.active").removeClass("active"),$(this).addClass("active"),size=$(this).attr("data-size"),colorer=$(this).attr("data-color"),type=$(".draw li.active").attr("data-type");break;case"gomme":$(".brushes li.active").removeClass("active"),$(this).addClass("active"),size=$(this).attr("data-size"),colorer=$(this).attr("data-color"),type=$(".draw li.active").attr("data-type");break;case"cancel":"cutter"===type?(deleted_story.decoupes.push(decoupe.getChildAt(decoupe.getNumChildren()-1)),decoupe.removeChildAt(decoupe.getNumChildren()-1),_draw.stage.update()):(deleted_story.gravures.push(gravure.getChildAt(gravure.getNumChildren()-1)),gravure.removeChildAt(gravure.getNumChildren()-1),_draw.stage.update());break;case"redraw":"cutter"===type?deleted_story.decoupes.length>0&&(decoupe.addChild(deleted_story.decoupes[deleted_story.decoupes.length-1]),deleted_story.decoupes.pop()):deleted_story.gravures.length>0&&(gravure.addChild(deleted_story.gravures[deleted_story.gravures.length-1]),deleted_story.gravures.pop()),_draw.stage.update();break;case"cutter":$(".brushes li.active").removeClass("active"),$(this).addClass("active"),size=$(this).attr("data-size"),colorer=$(this).attr("data-color"),type=$(".draw li.active").attr("data-type");break;case"clear":deleted_story={decoupes:[],gravures:[]},gravure.removeAllChildren(),decoupe.removeAllChildren(),_draw.stage.update();break;case"svg":_draw.convert_to_svg()}})},draw.prototype.init_drawing=function(){_draw.stage=new createjs.Stage("drawing_canvas"),_draw.stage.autoClear=!0,gravure=new createjs.Container,gravure.name="gravure",_draw.stage.addChild(gravure),decoupe=new createjs.Container,decoupe.name="decoupe",_draw.stage.addChild(decoupe),gravure.mask=decoupe,_draw.stage.on("stagemousedown",_draw.handleMouseDown),_draw.stage.on("stagemouseup",_draw.handleMouseUp),createjs.Touch.enable(_draw.stage),_draw.stage.update(),createjs.Ticker.addEventListener("tick",_draw.tick)},draw.prototype.play=function(){createjs.Ticker.addEventListener("tick",_draw.tick)},draw.prototype.pause=function(){createjs.Ticker.removeListener(window)},draw.prototype.update=function(){},draw.prototype.tick=function(){if(_draw.isMouseDown){if("cutter"!==type){if(currentShape.graphics.setStrokeStyle(size,"round"),-1!==colorer.indexOf("#"))currentShape.graphics.beginStroke(colorer);else if(-1!==colorer.indexOf("#")){var e=createjs.Graphics.getRGB(parseInt(colorer),parseInt(colorer),parseInt(colorer));currentShape.graphics.beginStroke(e)}else{var e=createjs.Graphics.getRGB(parseInt(colorer),parseInt(colorer),parseInt(colorer));currentShape.graphics.beginStroke(e)}var t=new createjs.Point(_draw.stage.mouseX,_draw.stage.mouseY),s=new createjs.Point(oldX+t.x>>1,oldY+t.y>>1);currentShape.graphics.lineTo(s.x,s.y),currentShape.graphics.curveTo(oldX,oldY,oldMidX,oldMidY),oldX=t.x,oldY=t.y,oldMidX=s.x,oldMidY=s.y}else{var t=new createjs.Point(_draw.stage.mouseX,_draw.stage.mouseY),s=new createjs.Point(oldX+t.x>>1,oldY+t.y>>1);currentShape.graphics.lineTo(_draw.stage.mouseX,_draw.stage.mouseY),oldX=t.x,oldY=t.y,oldMidX=s.x,oldMidY=s.y}_draw.stage.update()}},draw.prototype.handleMouseDown=function(){if(startX=_draw.stage.mouseX,startY=_draw.stage.mouseY,oldX=_draw.stage.mouseX,oldY=_draw.stage.mouseY,oldMidX=_draw.stage.mouseX,oldMidY=_draw.stage.mouseY,_draw.isMouseDown=!0,"cutter"!==type){var e=new createjs.Shape,t=e.graphics;30*Math.random()+10|0;t.setStrokeStyle(size,"round");var r=(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,createjs.Graphics.getRGB(parseInt(colorer),parseInt(colorer),parseInt(colorer)));t.beginStroke(r),gravure.addChild(e),currentShape=e}else{decoupe.removeAllChildren();var e=new createjs.Shape,t=e.graphics;30*Math.random()+10|0;t.setStrokeStyle(size,"round"),t.beginStroke(colorer),decoupe.addChild(e),currentShape=e}currentShape.graphics.moveTo(startX,startY)},draw.prototype.handleMouseUp=function(){"cutter"===type&&currentShape.graphics.closePath();for(var e=0;e<decoupe.getNumChildren();e++)gravure.mask=decoupe.getChildAt(e);_draw.stage.update(),_draw.isMouseDown=!1},draw.prototype.refresh=function(e){},draw.prototype.convert_to_svg=function(){function h(){var t=new XMLSerializer,s=t.serializeToString(e.svg),i=JSON.parse(window.localStorage.getItem("containers"));i[app._page_request.id].path="data:image/svg+xml,\n"+encodeURIComponent(s),window.localStorage.setItem("containers",JSON.stringify(i)),app._router.navigate("page/free/",{trigger:!0,replace:!1})}this.draw_cotent=new createjs.Container,this.stage.addChild(this.draw_cotent),this.draw_cotent.addChild(gravure),this.draw_cotent.addChild(decoupe),gravure.x=0,gravure.y=0,decoupe.x=0,decoupe.y=0;var e=new SVGExporter(this.draw_cotent,!1,!1,!1);(new Date).getTime();e.run(),console.log("exporter.svg ",e.svg),$(".draw").append('<div id="svg" style="width:'+window.innerWidth+"px; height:"+window.innerHeight+'px;"></div>'),$("#svg").append(e.svg);var s=document.getElementById("container"),i=s.getBBox(),n={x:i.x,y:i.y,w:i.width,h:i.height},r=($("#container").attr("transform","translate(0 0)"),document.getElementById("svg"));console.log(n);var o='<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="'+n.width+'" height="'+n.height+'">';o+=r.innerHtml,o+="</svg>",$("#svg").html(o),setTimeout(h,1)},draw.prototype.resize=function(e){$("#drawing_canvas").css({width:window.innerWidth,height:window.innerHeight}),$("#drawing_canvas").attr({width:window.innerWidth,height:window.innerHeight})},draw.prototype.destroy=function(e){e()};