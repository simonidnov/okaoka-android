function gallery_page(){this._characters=[],this.swiper=null,this.scroll=null,this._datas=null,this._page=1,this.limit=20}gallery_page.prototype.init=function(){this.display_list()},gallery_page.prototype.display_list=function(){var e=this;$("article").css("height",window.innerHeight+"px"),$("#scroll_scroller").css("height",$("article").length*window.innerHeight+"px"),$("#gallery_container").css({width:300*Math.floor(window.innerWidth/300)+"px"}),characters_helper.get_characters_with_params({limit:this.limit,"no-datas":!0},function(t){e._datas=t,e.create_cards()},!0)},gallery_page.prototype.scroll_to=function(e){app.page_properties._page_script.scroll.scrollToElement(document.querySelector("#scroll_scroller article:nth-child("+e+")"),700,null,null,IScroll.utils.ease.quadratic)},gallery_page.prototype.create_cards=function(){for(var e=this,t=_.template($("#gallery_card_template").html()),s=0;s<this._datas.length;++s)$("#gallery_container").append(t(this._datas[s])),TweenLite.set($("#card_"+this._datas[s].id),{y:window.innerHeight}),TweenLite.to($("#card_"+this._datas[s].id),.8,{y:0,delay:.2*s,ease:Power4.easeOut,onStart:function(){app.play_sound("card")}});$(".gallery_card .card_pix").off("touchstart").on("touchstart",function(t){e.touch_start={x:t.originalEvent.touches[0].pageX,y:t.originalEvent.touches[0].pageY},e.default_position=$(this).parent().position(),e.current_target=$(this).parent(),e.current_target.addClass("selected")}),$(".gallery_card .card_pix").off("touchmove").on("touchmove",function(t){e.touch_move={x:t.originalEvent.touches[0].pageX,y:t.originalEvent.touches[0].pageY};var s=e.touch_start.x-e.touch_move.x;TweenMax.set(e.current_target,{left:e.touch_move.x-e.touch_start.x+"px",rotation:s/10})}),$(".gallery_card .card_pix").off("touchend").on("touchend",function(t){var s=e.touch_start.x-e.touch_move.x;if(Math.abs(s)>50){var i=e.current_target;s>0?(TweenMax.to(e.current_target,.5,{rotation:30,left:2*-window.innerWidth-200,ease:Power4.easeIn,onComplete:function(){i.remove(),e.check_last()}}),app.play_sound("win")):(TweenMax.to(e.current_target,.5,{rotation:-30,left:window.innerWidth+200,ease:Power4.easeIn,onComplete:function(){i.remove(),e.check_last()}}),app.play_sound("fail"))}else TweenMax.to(e.current_target,.5,{rotation:0,left:e.default_position.left,top:e.default_position.top,ease:Elastic.easeOut}),app.play_sound("card")}),$("[data-cardaction]").off("touchend").on("touchend",function(t){var s=$(this).parent().parent();switch($(this).attr("data-cardaction")){case"like":app.play_sound("win"),ajax_request.post("/nse/like",{character_id:$(this).attr("data-id")},function(e){},function(e){}),TweenMax.to(s,.5,{left:2*-window.innerWidth-200,rotation:40,ease:Power4.easeIn,onComplete:function(){s.remove(),e.check_last()}}),console.log("like");break;case"favorite":app.play_sound("win"),ajax_request.post("/nse/favorite",{character_id:$(this).attr("data-id")},function(e){},function(e){}),TweenMax.to(s,.5,{top:-window.innerHeight,rotation:-40,ease:Power4.easeIn,onComplete:function(){s.remove(),e.check_last()}}),console.log("favorite");break;case"next":app.play_sound("fail"),TweenMax.to(s,.5,{left:window.innerWidth+200,rotation:-40,ease:Power4.easeIn,onComplete:function(){s.remove(),e.check_last()}}),console.log("next")}})},gallery_page.prototype.check_last=function(){var e=this;0===$(".gallery_card").length&&(this._page+=1,characters_helper.get_characters_with_params({start:this.limit*this._page,limit:this.limit,"no-datas":!0},function(t){e._datas=t,e.create_cards()},!0))},gallery_page.prototype.create_grid=function(){for(var e=_.template($("#gallery_template").html()),t=0;t<this._datas.length;++t)$("#gallery_container").append(e(this._datas[t]));this.set_listeners();var s=this;this.scroll=new IScroll("#gallery_scroll_wrapper",{disableMouse:!1,probeType:1,scrollbars:!1,interactiveScrollbars:!1,fadeScrollbars:!1,mouseWheel:!0,click:!0,tap:!0,keyBindings:!0,deceleration:.001}),this.scroll.on("scrollEnd",function(){s.scroll.y===s.scroll.maxScrollY&&s.load_next_page()})},gallery_page.prototype.set_listeners=function(){var e=this;$(".gallery_list").off("click").on("click",function(){var t=$(this).attr("data-id"),s=new PopUp;s.open_popup({illus:{color:"white",picture:$(this).attr("data-pix")},title:$(this).find(".label").html(),message:"Que souhaitez-vous faire ?",buttons:[{label:"Modifier"},{label:"Partager"},{label:"Rien"}]},function(i,n){0===parseInt(i)?e.load_character(t):1===parseInt(i)&&e.download_character(t),delete s})})},gallery_page.prototype.load_character=function(e){setTimeout(function(){app._router.navigate("page/character/id/"+e,{trigger:!0,replace:!1})},30)},gallery_page.prototype.download_character=function(e){var t=new PopUp;t.open_popup({illus:{color:"white",picture:$('[data-id="'+e+'"]').attr("data-pix")},title:"Télécharger : "+$('[data-id="'+e+'"]').find(".label").html(),message:"Quel format souhaitez-vous télécharger ?",buttons:[{label:"SVG"},{label:"PNG"},{label:"Annuler"}]},function(s,i){0===parseInt(s)?window.open($('[data-id="'+e+'"]').attr("data-pix").replace(".png",".svg").replace("_thumb",""),"_blank"):1===parseInt(s)&&window.open($('[data-id="'+e+'"]').attr("data-pix").replace("_thumb",""),"_blank"),delete t})},gallery_page.prototype.add_grid=function(){for(var e=_.template($("#gallery_template").html()),t=0;t<this._datas.length;++t)$("#gallery_container").append(e(this._datas[t]));this.set_listeners();this.scroll.refresh(),this.scroll.y=this.scroll.y-20},gallery_page.prototype.load_next_page=function(){var e=this;ajax_request.get("/nse/character",{start:this.limit*this._page,limit:this.limit},function(t){e._datas=t.result,e.add_grid(),e._page+=1},function(e){alert("erreur lors de la recherche")})},gallery_page.prototype.set_canvas=function(e,t){this._characters[e]=new character({touch_enabled:!1,canvas:"canvas_"+e,width:250,height:300,datas:t}),this._characters[e].init()},gallery_page.prototype.play=function(){},gallery_page.prototype.pause=function(){},gallery_page.prototype.update=function(){},gallery_page.prototype.refresh=function(e){},gallery_page.prototype.destroy=function(e){for(var t=this,s=0;s<this._characters.length;s++)this._characters[s].destroy(function(){s===t._characters.length-1&&(t._characters=[],e())})};